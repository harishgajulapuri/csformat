
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>identity_map_in_rails - Codingarena</title>
  <meta name="author" content="Manu S Ajith">
  <link rel="author" href="humans.txt">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  
    
  
  <meta name="description" content="I was recently working on a project that was&#8217;nt maintained for some time and the test cases were failing too. I started upgrading the &hellip;">
  
  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://manusajith.github.io/blog/2013/12/15/identity-map-in-rails/">
  <link href="/blog/favicon.png" rel="icon">
  <link href='http://fonts.googleapis.com/css?family=Cantarell' rel='stylesheet' type='text/css'>
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Codingarena" type="application/atom+xml">
  <meta name="og:type" content="website" />
  <meta name="og:site_name" content="Codingarena" />
  <meta name="og:title" content="identity_map_in_rails" />
  <meta name="og:description" content="I was recently working on a project that was&#8217;nt maintained for some time and the test cases were failing too. I started upgrading the &hellip;" />
  <meta name="og:url" content="http://manusajith.github.io/blog/2013/12/15/identity-map-in-rails/"/>
  <meta name="url" content="http://manusajith.github.io/blog/2013/12/15/identity-map-in-rails/">
  
  <meta name="subject" content="ActiveRecord,RailsRuby,"/>
  <meta name="category" content="ActiveRecord,RailsRuby,"/>
  
  <meta name="distribution" content="global">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-30559513-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <nav role="navigation"><div class="navbar">
  <div class="navbar-inner">
    <a class="brand" href="/blog/">Codingarena</a>
    <ul class="nav">
      <li><a href="/blog/">Home</a></li>
      <li><a href="/blog/blog/archives">Archives</a></li>
    </ul>
    <ul class="nav" data-subscription="rss">
      <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
      
    </ul>
      
    <form class="navbar-form" action="http://google.com/search" method="get">
      <fieldset role="search">
        <input type="hidden" name="q" value="site:manusajith.github.io" />
        <input class="span2" type="text" name="q" results="0" placeholder="Search"/>
      </fieldset>
    </form>
      
    
  </div>
</div>
</nav>
  <div class="wrapper_single">
    <div class="container">
      <article class="span8 offset2" role="article">
        <div class="article-format">

  <header>
    
      <h1 class="entry-title">Identity_map_in_rails</h1>
    
    
      <p class="meta">
        
  


  
    <span class="byline author vcard">by <a href="https://plus.google.com/110007023591027468321?rel=author"><span class="fn">Manu S Ajith</span></a></span>
  

 - 
        








  


<time datetime="2013-12-15T04:07:41+05:30" pubdate data-updated="true">Dec 15<span>th</span>, 2013</time> - 
        

posted in
<span class="categories">
  
    <a class='category' href='/blog/categories/activerecord/'>ActiveRecord,</a>, <a class='category' href='/blog/categories/rails/'>Rails</a>, <a class='category' href='/blog/categories/ruby/'>Ruby,</a>
  
</span>


        
      </p>
    
  </header>


  <div class="entry-content"><p>I was recently working on a project that was&#8217;nt maintained for some time and the test cases were failing too. I started upgrading the application to the latest version and some of the test cases were still failing.
Looking deeper into the logs I could find that I was getting an wierd error with IdentityMap when using with a Rails4 app. I did some googling and found that identity_map was removed from Rails4.</p>

<h2>What is IdentityMap ?</h2>

<p>Ensures that each object gets loaded only once by keeping every loaded object in a map. Looks up objects using the map when referring to them. More details on the IdentityMap pattern can be found <a href="" title="http://www.martinfowler.com/eaaCatalog/identityMap.html">here</a> on a blog post by Martin Fowler</p>

<!--more -->


<h2>Configuration</h2>

<p>In order to enable IdentityMap, set <code>config.active_record.identity_map = true</code> in your config/application.rb file.</p>

<p>Identitymap configuration has been removed from Rails4. If you are upgrading Rails 4 from Rails 3, then please be sure to remove/comment the line from config/application.rb</p>

<h2>Issues with IdentityMap</h2>

<h3>Associations</h3>

<p>Active Record Identity Map does not track associations yet. For example:</p>

<pre><code>comment = @post.comments.first
comment.post = nil
@post.comments.include?(comment) #=&gt; true
</code></pre>

<p>Ideally, the example above would return false, removing the comment object from the post association when the association is nullified. This may cause side effects, as in the situation below, if Identity Map is enabled:</p>

<pre><code>Post.has_many :comments, :dependent =&gt; :destroy

comment = @post.comments.first
comment.post = nil
comment.save
Post.destroy(@post.id)
</code></pre>

<p>Without using Identity Map, the code above will destroy the @post object leaving the comment object intact. However, once we enable Identity Map, the post loaded by Post.destroy is exactly the same object as the object @post. As the object @post still has the comment object in @post.comments, once Identity Map is enabled, the comment object will be accidently removed.</p>

<p>This inconsistency wasnt fixed and was the main reason for the removal of identitymao from Rails4.</p>

<p>Other two minor problems are:</p>

<p>If you inheriting models, and you want to switch from one typo of object to another, then first you need delete your object from identity map, and after that create a new object. Example:</p>

<pre><code>class A &lt; ActiveRecord::Base
end

class B &lt; ActiveRecord::Base
end

a = A.create!
a.update_attribute :type, 'B'
b = B.find a.id
#=&gt; #&lt;A:...&gt;
ActiveRecord::IdentityMap.remove(a) if ActiveRecord::IdentityMap.enabled?
b = B.find a.id
#=&gt; #&lt;B:...&gt;
</code></pre>

<p>Another small issue is that the identity map may mees up the thing in the tests. As it do not truncates its repository after each test. To make it to do so one needs to add that into test framework configurations. Rspec example:</p>

<pre><code>RSpec.configure do |config|
  config.after :each do
    DatabaseCleaner.clean
    ActiveRecord::IdentityMap.clear
  end
end
</code></pre>

<p>My opinion is that identity map may be used, but partially. It is a bad idea to enable it by default for each single object, but it will be a good idea to enable it to specific models. Say, you have a table of languages, which is pretty static data, or may by countries. Why not to load them all in to identity map. But, with dynamic data (like users, or something different, that constantly changes), there is no need to store that in the memory.</p>

<p>The official documentation states clearly that the identitymap is still under development, so no one should really be using it in the wild.</p>
</div>


  <footer>
    <p class="meta">
      
  


  
    <span class="byline author vcard">by <a href="https://plus.google.com/110007023591027468321?rel=author"><span class="fn">Manu S Ajith</span></a></span>
  

 - 
      








  


<time datetime="2013-12-15T04:07:41+05:30" pubdate data-updated="true">Dec 15<span>th</span>, 2013</time> - 
      

posted in
<span class="categories">
  
    <a class='category' href='/blog/categories/activerecord/'>ActiveRecord,</a>, <a class='category' href='/blog/categories/rails/'>Rails</a>, <a class='category' href='/blog/categories/ruby/'>Ruby,</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://manusajith.github.io/blog/2013/12/15/identity-map-in-rails/" data-via="manusajith" data-counturl="http://manusajith.github.io/blog/2013/12/15/identity-map-in-rails/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    
      <a class="pull-left" href="/blog/2013/11/25/fix-for-ruby-1-dot-8-7-incompatibity-undefined-method-for-enumerable-bug/" title="Previous Post: Fix for ruby 1.8.7 incompatibity - undefined method for Enumerable bug">&laquo; Fix for ruby 1.8.7 incompatibity - undefined method for Enumerable bug</a>
    
    
      <a class="pull-right" href="/blog/2014/01/20/lunchy-a-friendly-wrapper-for-os-x-launchctl/" title="Next Post: lunchy: A friendly wrapper for OS X launchctl">lunchy: A friendly wrapper for OS X launchctl &raquo;</a>
    
  </footer>

</div>

        
          <div class="article-format">
            <h1>Comments</h1>
            <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
          </div>
        
      </article>
    </div>
  </div>
  <div id="footer-widgets">
  <div class="container">
    <div class="row">
  <div class="span3">
    <h2>recent posts</h2>
    <ul class="recent_posts">
      
        <li>
          <a href="/blog/blog/2014/01/20/lunchy-a-friendly-wrapper-for-os-x-launchctl/">lunchy: A friendly wrapper for OS X launchctl</a>
        </li>
      
        <li>
          <a href="/blog/blog/2013/12/15/identity-map-in-rails/">identity_map_in_rails</a>
        </li>
      
        <li>
          <a href="/blog/blog/2013/11/25/fix-for-ruby-1-dot-8-7-incompatibity-undefined-method-for-enumerable-bug/">Fix for ruby 1.8.7 incompatibity - undefined method for Enumerable bug</a>
        </li>
      
        <li>
          <a href="/blog/blog/2013/11/22/mathjax-rails/">mathjax-rails</a>
        </li>
      
        <li>
          <a href="/blog/blog/2013/06/27/use-specific-version-of-rails-before-creating-a-new-app/">Use Specific version of rails before creating  a new app</a>
        </li>
      
    </ul>
    <h2><a href="/blog/archives">archives</a></h2>
  </div>
  <div class="span3">
    

  </div>
  <div class="span4">
    
<h2>twitter</h2>
<a href="https://twitter.com/manusajith" class="twitter-follow-button" data-show-count="true" data-lang="en">Follow @manusajith</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
<div class="tweet" data-twitter-user="manusajith">
</div>


  </div>
  <div class="span2">
    <h2>found on</h2>

<a href="https://github.com/manusajith/" rel="tooltip" title="Github"><img class="social_icon" title="Github" alt="github icon" src="/blog/images/glyphicons_381_github.png"></a>







<a href="http://twitter.com/manusajith" rel="tooltip" title="Twitter"><img class="social_icon" title="Twitter" alt="Twitter icon" src="/blog/images/glyphicons_391_twitter_t.png"></a>



<a href="https://plus.google.com/110007023591027468321?rel=author" rel="tooltip" title="Google Plus"><img class="social_icon" title="Google Plus" alt="Google Plus icon" src="/blog/images/glyphicons_386_google_plus.png"></a>





<h2>contact at</h2>
<a href="mailto:neo@codingarena.in">neo@codingarena.in</a>


  </div>
</div>

  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-left">
  <a href="/blog/">Codingarena</a>
  - Copyright &copy; 2014 - Manu S Ajith
</p>
<p class="pull-right">
  <span>Powered by <a href="http://octopress.org/">Octopress</a>.</span>
  
    <span>Designed by <a href="http://www.AdrianArtiles.com">Adrian Artiles</a>.</span>
  
</p>

  </div>
</footer>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<script>window.jQuery || document.write('<script src="/blog/javascripts/libs/jquery-1.7.2.min.js" type="text/javascript"><\/script>')</script>
<script src="/blog/javascripts/libs/bootstrap.min.js" type="text/javascript"></script>
<script src="/blog/javascripts/jquery.tweet.js" type="text/javascript"></script>
<script src="/blog/javascripts/jquery.instagram.js" type="text/javascript"></script>
<script src="/blog/javascripts/libs/jquery.masonry.min.js" type="text/javascript"></script>
<script src="/blog/javascripts/custom.js" type="text/javascript"></script>


<script type="text/javascript">
      var disqus_shortname = 'codingarenablog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://manusajith.github.io/blog/2013/12/15/identity-map-in-rails/';
        var disqus_url = 'http://manusajith.github.io/blog/2013/12/15/identity-map-in-rails/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




</body>
</html>
