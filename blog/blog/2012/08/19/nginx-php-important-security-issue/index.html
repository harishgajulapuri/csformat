
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Nginx & PHP important security issue - Codingarena</title>
  <meta name="author" content="Manu S Ajith">
  <link rel="author" href="humans.txt">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  
    
  
  <meta name="description" content="A critical security issue has recently been pointed out on servers that run Nginx and PHP via FastCGI. The issue allows anyone to execute their own &hellip;">
  
  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://manusajith.github.io/blog/blog/2012/08/19/nginx-php-important-security-issue/">
  <link href="/blog/favicon.png" rel="icon">
  <link href='http://fonts.googleapis.com/css?family=Cantarell' rel='stylesheet' type='text/css'>
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/blog/atom.xml" rel="alternate" title="Codingarena" type="application/atom+xml">
  <meta name="og:type" content="website" />
  <meta name="og:site_name" content="Codingarena" />
  <meta name="og:title" content="Nginx & PHP important security issue" />
  <meta name="og:description" content="A critical security issue has recently been pointed out on servers that run Nginx and PHP via FastCGI. The issue allows anyone to execute their own &hellip;" />
  <meta name="og:url" content="http://manusajith.github.io/blog/blog/2012/08/19/nginx-php-important-security-issue/"/>
  <meta name="url" content="http://manusajith.github.io/blog/blog/2012/08/19/nginx-php-important-security-issue/">
  
  <meta name="subject" content=""/>
  <meta name="category" content=""/>
  
  <meta name="distribution" content="global">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-30559513-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <nav role="navigation"><div class="navbar">
  <div class="navbar-inner">
    <a class="brand" href="/blog/">Codingarena</a>
    <ul class="nav">
      <li><a href="/blog/">Home</a></li>
      <li><a href="/blog/blog/archives">Archives</a></li>
    </ul>
    <ul class="nav" data-subscription="rss">
      <li><a href="/blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
      
    </ul>
      
    <form class="navbar-form" action="http://google.com/search" method="get">
      <fieldset role="search">
        <input type="hidden" name="q" value="site:manusajith.github.io/blog" />
        <input class="span2" type="text" name="q" results="0" placeholder="Search"/>
      </fieldset>
    </form>
      
    
  </div>
</div>
</nav>
  <div class="wrapper_single">
    <div class="container-fluid">
      <div class="row-fluid">
        <article class="span8 offset1" role="article">
          <div class="article-format">

  <header>
    
      <h1 class="entry-title">Nginx & PHP Important Security Issue</h1>
    
    
      <p class="meta">
        
  


  
    <span class="byline author vcard">by <a href="https://plus.google.com/110007023591027468321?rel=author"><span class="fn">Manu S Ajith</span></a></span>
  

 - 
        








  


<time datetime="2012-08-19T00:00:00+05:30" pubdate data-updated="true">Aug 19<span>th</span>, 2012</time> - 
        


        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A critical security issue has recently been pointed out on servers that run Nginx and PHP via FastCGI. The issue allows anyone to execute their own PHP code on the system, I don&rsquo;t think I have to remind you of the consequences this could have. I will attempt to provide a simple explanation of the issue and more importantly how to fix it.</p>

<h2>What is the issue?</h2>

<p>I would like to begin by discussing the nature of the problem: it is not caused by Nginx itself &ndash; it is not a bug or a security breach in itself. Actually, it is the way that people usually configure Nginx FastCGI options to work with PHP, and how PHP reacts to that configuration. Pretty much everyone adopts the same configuration without being aware of the issue.</p>

<p>The issue itself can be understood simply, then I will explain why PHP behaves that way. Most dynamic websites allow for a reason or another uploading of files. Say, I&rsquo;m running a forum-based community, users can upload images to use as personal photo or avatar. The photo gets uploaded and you get the following URL:</p>

<p><code><em><a href="http://myforum.com/uploads/photo1234.jpg">http://myforum.com/uploads/photo1234.jpg</a></em></code></p>

<p>The breach consists in appending an additional path element to the URL, making it end in .php:</p>

<p><code><em><a href="http://myforum.com/uploads/photo1234.jpg/anything.php">http://myforum.com/uploads/photo1234.jpg/anything.php</a></em></code></p>

<p>Under certain conditions (and unfortunately with default settings), your photo1234.jpg gets processed as PHP file. So you could upload a PHP script renamed as .jpg, upload the image, then execute the script on the server.</p>

<p>If you want to know instantly if your server is vulnerable to this attack, there is a simple way to know. Find a regular file on your server, such as</p>

<p><code><em><a href="http://myforum.com/robots.txt.">http://myforum.com/robots.txt.</a></em></code></p>

<p>Examine the HTTP headers of the response:</p>

<pre><code>HTTP/1.1 200 OK
Server: nginx/0.7.64
Date: Wed, 26 May 2010 10:56:01 GMT
Content-Type: text/plain
Content-Length: 43
(...)
</code></pre>

<p>Now add /test.php after the URL:</p>

<p><code><em> <a href="http://myforum.com/robots.txt/test.php:">http://myforum.com/robots.txt/test.php:</a> </em></code></p>

<pre><code>HTTP/1.1 200 OK
Server: nginx/0.7.64
Date: Wed, 26 May 2010 10:56:01 GMT
Content-Type: text/plain
Content-Length: 43
(...)
X-Powered-By: PHP/5.2.3
</code></pre>

<p>The X-Powered-By header was added by PHP which shows that the file was processed by PHP. Now visit that URL <a href="http://myforum.com/robots.txt/test.php">http://myforum.com/robots.txt/test.php</a> in your web browser. What do you see:</p>

<ul>
<li>do you see the robots.txt file ? if so, your server is vulnerable.</li>
<li>do you see an error page (403, 404, 500, 502&hellip;) or just a simple message &ldquo;No input file specified&rdquo; ? if so, your server is not affected by the problem.</li>
</ul>


<h2>Why does this happen?</h2>

<p>There are two main reasons why this happens. First let&rsquo;s have a look at the data Nginx transmits to PHP.
A regular FastCGI/PHP configuration would be as follows:</p>

<pre><code>fastcgi_pass 127.0.0.1:9000;
fastcgi_index index.php;
fastcgi_param SCRIPT_FILENAME &lt;em&gt;/var/www/vhosts/myforum.com/httpdocs$fastcgi_script_name;&lt;/em&gt;
fastcgi_param PATH_INFO $fastcgi_script_name;
</code></pre>

<p>When requesting an URL like<em> <a href="http://myforum.com/uploads/photo1234.jpg/anything.php">http://myforum.com/uploads/photo1234.jpg/anything.php</a></em> to Nginx, here is the data that gets sent:</p>

<pre><code>fastcgi_param SCRIPT_FILENAME &lt;em&gt;/var/www/vhosts/myforum.com/httpdocs/uploads/photo1234.jpg/anything.php;&lt;/em&gt;
fastcgi_param PATH_INFO /robots.txt/test.php;
</code></pre>

<p>So far, no problem. PHP is supposed to load a file anything.php, in the directory <em>/var/www/vhosts/myforum.com/httpdocs/uploads/photo1234.jpg/.</em> Naturally, this directory should not exist, and anything.php shouldn&rsquo;t exist either, so we should be getting a 404 error.
However, that&rsquo;s where the problem comes in. The PHP option cgi.fix_pathinfo, when enabled (and it is usually enabled by default) will transform these two parameters. The SCRIPT_FILENAME becomes <em>/var/www/vhosts/myforum.com/httpdocs/uploads/photo1234.jpg,</em> which means the .jpg file actually becomes the request filename, and it gets treated as PHP. And PATH_INFO becomes /anything.php. The original purpose of this option was to allow such kind of URLs: index.php/param1/param2/&hellip;
But when combined with Nginx, this turns into a major issue.</p>

<h2>How do I fix it?</h2>

<p>Well, the simplest thing you can do is open up your php.ini configuration file, and insert this directive in the main section:</p>

<pre><code>cgi.fix_pathinfo=0
</code></pre>

<p>Then restart PHP-FPM or whatever FastCGI manager you&rsquo;re using.</p>

<p>Unfortunately in some cases that is not possible a solution, since perhaps other scripts on your server make the most of this option. So you could do mainly employ two different solutions on the Nginx side.</p>

<p>First, you could check that the requested URI actually exists, before passing the request via FastCGI:</p>

<pre><code>location \.php$ {
    if (!-f $request_filename) {
        return 404;
    }
    fastcgi_pass 127.0.0.1:9000;
    [...]
}
</code></pre>

<p>This solution is efficient and a few of us Nginx+PHP have retained it.
Otherwise, if you think it&rsquo;s too consuming in terms of resources, you could check the URI to meet the following requirements:
&ndash; if the URI contains a dot, then a slash (example: image.jpg/&hellip;)
&ndash; if the URI ends with &ldquo;.php&rdquo; (example: image.jpg/test.php)
&ndash; then return a 403 error.</p>

<pre><code>location ~ \..*/.*\.php$ {
    return 403;
}
location ~ \.php$ {
    fastcgi_pass 127.0.0.1:9000;
    ...
}
</code></pre>

<p>Alternatively, you could make sure that PHP is only enabled in certain directories, where file uploads are not allowed:</p>

<pre><code>location ~ ^/(scripts|sources|src)/.*\.php$ {
    fastcgi_pass 127.0.0.1:9000;
    ...
}
</code></pre>

<p><a href="http://facebook.com/manusajth">Manu</a></p>

<p><a href="www.codingarena.in">www.codingarena.in</a></p>

<p><a href="http://twitter.com/manusajith" title="Twitter">@manusajith</a> | <a href="http://github.com/manusajith" title="Github">@github</a></p>
</div>


  <footer>
    <p class="meta">
      
  


  
    <span class="byline author vcard">by <a href="https://plus.google.com/110007023591027468321?rel=author"><span class="fn">Manu S Ajith</span></a></span>
  


      








  


<time datetime="2012-08-19T00:00:00+05:30" pubdate data-updated="true">Aug 19<span>th</span>, 2012</time>
      


    </p>
    
      <div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>

    
    
      <a class="pull-left" href="/blog/2012/08/13/my-hack-cupids-buzz-at-yahoo-open-hack-2012/" title="Previous Post: My Hack (Cupid's Buzz) at Yahoo! Open Hack 2012">&laquo; My Hack (Cupid's Buzz) at Yahoo! Open Hack 2012</a>
    
    
      <a class="pull-right" href="/blog/2012/08/31/installing-ioncube-loader-on-whmcpanel/" title="Next Post: Installing ioncube loader on WHM/cPanel">Installing ioncube loader on WHM/cPanel &raquo;</a>
    
  </footer>

</div>

          
        </article>
        <article class="span3 article-format" role="article">
          <div class="coderwall-endorse"><a href="https://coderwall.com/manusajith"><img alt="Endorse Manu S Ajith on Coderwall" src="http://api.coderwall.com/manusajith/endorsecount.png"></a></div>
          <embed type='application/x-shockwave-flash' src='/javascripts/tagcloud.swf'width='100%' height='250' bgcolor='#ffffff' id='tagcloudflash' name='tagcloudflash' quality='high' allowscriptaccess='always'flashvars="tcolor=0x333333&amp;tcolor2=0x333333&amp;hicolor=0x000000&amp;tspeed=100&amp;distr=true&amp;mode=tags&amp;tagcloud=%3Ctags%3E%3C%2Ftags%3E">
        </article>
      </div>
      </div>
    </div>
  </div>
  <div id="footer-widgets">
  <div class="container">
    <div class="row">
  <div class="span3">
    <h2>recent posts</h2>
    <ul class="recent_posts">
      
        <li>
          <a href="/blog/blog/2013/04/08/pdf-generation-in-rails-with-wicked_pdf/">PDF generation in Rails</a>
        </li>
      
        <li>
          <a href="/blog/blog/2012/11/22/google-code-jam/">Google Code Jam</a>
        </li>
      
        <li>
          <a href="/blog/blog/2012/10/30/154-server-monotoring-script/">Simple Server monitoring Shell Script</a>
        </li>
      
        <li>
          <a href="/blog/blog/2012/09/12/reset-root-password-in-xampp/">Reset root password in XAMPP</a>
        </li>
      
        <li>
          <a href="/blog/blog/2012/09/01/ubuntu-bonding-and-link-aggregation/">Ubuntu Bonding and link aggregation</a>
        </li>
      
    </ul>
    <h2><a href="/blog/archives">archives</a></h2>
  </div>
  <div class="span3">
    

  </div>
  <div class="span4">
    
<h2>twitter</h2>
<a href="https://twitter.com/manusajith" class="twitter-follow-button" data-show-count="true" data-lang="en">Follow @manusajith</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
<div class="tweet" data-twitter-user="manusajith">
</div>


  </div>
  <div class="span2">
    <h2>found on</h2>

<a href="https://github.com/manusajith/" rel="tooltip" title="Github"><img class="social_icon" title="Github" alt="github icon" src="/blog/images/glyphicons_381_github.png"></a>





<a href="http://www.linkedin.com/in/manusajith" rel="tooltip" title="Linkedin"><img class="social_icon" title="Linkedin" alt="Linkedin icon" src="/blog/images/glyphicons_377_linked_in.png"></a>



<a href="http://twitter.com/manusajith" rel="tooltip" title="Twitter"><img class="social_icon" title="Twitter" alt="Twitter icon" src="/blog/images/glyphicons_391_twitter_t.png"></a>



<a href="https://plus.google.com/110007023591027468321?rel=author" rel="tooltip" title="Google Plus"><img class="social_icon" title="Google Plus" alt="Google Plus icon" src="/blog/images/glyphicons_386_google_plus.png"></a>





<h2>contact at</h2>
<a href="mailto:neo@codingarena.in">neo@codingarena.in</a>


  </div>
</div>

  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-left">
  <a href="/blog/">Codingarena</a>
  - Copyright &copy; 2013 - Manu S Ajith
</p>
<p class="pull-right">
  <span>Powered by <a href="http://octopress.org/">Octopress</a>.</span>
</p>

  </div>
</footer>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<script>window.jQuery || document.write('<script src="/blog/javascripts/libs/jquery-1.7.2.min.js" type="text/javascript"><\/script>')</script>
<script src="/blog/javascripts/libs/bootstrap.min.js" type="text/javascript"></script>
<script src="/blog/javascripts/jquery.tweet.js" type="text/javascript"></script>
<script src="/blog/javascripts/jquery.instagram.js" type="text/javascript"></script>
<script src="/blog/javascripts/libs/jquery.masonry.min.js" type="text/javascript"></script>
<script src="/blog/javascripts/custom.js" type="text/javascript"></script>


<script type="text/javascript">
      var disqus_shortname = 'codingarenablog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




</body>
</html>
